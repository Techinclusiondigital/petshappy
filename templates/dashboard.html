{% extends "base.html" %}

{% block title %}Panel de Control{% endblock %}

{% block content %}
  {% if not current_user.subscripcion_id and not current_user.en_periodo_prueba() %}
    <div class="alert alert-danger text-center">
      <h2>ğŸš« Tu prueba gratuita ha caducado</h2>
      <p>Activa tu suscripciÃ³n para seguir usando la aplicaciÃ³n</p>  
    <div style="display: flex; justify-content: center;">
    <div id="paypal-button-container" style="max-width: 400px; width: 100%;"></div>
</div>

</div>
  {% elif current_user.en_periodo_prueba() and not current_user.subscripcion_id %}
    <div class="alert alert-info text-center">
      <h4>â³ Tu prueba gratuita finaliza en:</h4>
     <div id="contador" style="font-size: 16px; font-weight: bold;"></div>
    </div>
  {% endif %}

  <h2 class="text-center">ğŸ“… Agenda de Citas</h2>

  <div class="agenda-container">
    <a href="/cita" class="boton">â• Agendar nueva cita</a>
    <form method="GET" action="{{ url_for('dashboard') }}" class="fecha-form">
      <label for="fecha">ğŸ“… Selecciona una fecha:</label>
      <input type="date" id="fecha" name="fecha" required>
      <button class="btn-agenda">Ver agenda</button>
    </form>

    {% for fecha, nombre_dia, bloques in agenda %}
      <h4>ğŸ—“ï¸ {{ nombre_dia|capitalize }} {{ fecha.strftime("%d/%m/%Y") }}</h4>
      <ul class="list-group mb-3">
        {% for bloque in bloques %}
          <li class="bloque-horario {% if bloque.enlace %}libre{% else %}ocupado{% endif %}">
            {% if bloque.enlace %}
              <a href="{{ bloque.enlace }}" class="bloque-libre">{{ bloque.texto }}</a>
            {% else %}
              <strong class="text-danger">{{ bloque.texto }}</strong>
              {% if bloque.cita_id %}
                <form action="/actualizar_pago/{{ bloque.cita_id }}" method="POST" class="d-flex align-items-center gap-2 mt-2">
                  <select name="metodo_pago" class="form-select form-select-sm">
                    <option value="">MÃ©todo</option>
                    <option value="efectivo" {% if bloque.metodo_pago == 'efectivo' %}selected{% endif %}>ğŸ’µ Efectivo</option>
                    <option value="tarjeta" {% if bloque.metodo_pago == 'tarjeta' %}selected{% endif %}>ğŸ’³ Tarjeta</option>
                  </select>
                  <input type="number" step="0.01" name="precio" placeholder="â‚¬" value="{{ bloque.precio or '' }}" class="form-control form-control-sm" style="width: 80px;">
                  <button type="submit" class="btn btn-sm btn-success">ğŸ’¾</button>
                </form>
                <form method="POST" action="/anular_cita/{{ bloque.cita_id }}" class="d-inline mt-1">
                  <button type="submit" class="btn btn-sm btn-danger">âŒ Anular</button>
                </form>
                {% if bloque.cita_id %}
  {% set mascota = bloque.mascota %}
  {% set telefono = mascota.telefono.replace(" ", "").replace("-", "") %}
  {% set mensaje = "Hola! Te recordamos que tienes una cita maÃ±ana con tu mascota " ~ mascota.nombre ~ " a las " ~ bloque.hora %}
  <a class="btn btn-success btn-sm"
     target="_blank"
     href="https://wa.me/34{{ telefono }}?text={{ mensaje | urlencode }}">
     ğŸ“² Recordar por WhatsApp
  </a>
{% endif %}

              {% endif %}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endfor %}
  </div>

  <h3>ğŸ“‹ Arqueo del dÃ­a</h3>
  <form method="GET" action="/arqueo">
    <button type="submit" class="btn btn-warning">ğŸ’° Ver arqueo de caja</button>
  </form>

{% endblock %}


{% block scripts %}
  {% if not current_user.subscripcion_id and not current_user.en_periodo_prueba() %}
    <script src="https://www.paypal.com/sdk/js?client-id=AdKDB9XxfhHs8k-nO1sNPQVn2S2-kEih3HgO9Byj147xHOB4FLaIUVc0EGId3a6oECFgrdGP54KsQAUK&vault=true&intent=subscription"></script>
    <script>
      paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'gold',
          layout: 'vertical',
          label: 'subscribe'
          
        },
        createSubscription: function(data, actions) {
          return actions.subscription.create({
            plan_id: 'P-0YP52904YG949224RNAY3BJY'
          });
        },
        onApprove: function(data, actions) {
          alert("âœ… SuscripciÃ³n realizada. ID: " + data.subscriptionID);
          window.location.href = "/suscripcion_exitosa?sub_id=" + data.subscriptionID;
        }
      }).render('#paypal-button-container');
    </script>
  {% elif current_user.en_periodo_prueba() and not current_user.subscripcion_id %}
    <script>
      const finPrueba = new Date("{{ fecha_fin_prueba }}");

      function actualizarContador() {
        const ahora = new Date();
        const tiempoRestante = finPrueba - ahora;

        if (tiempoRestante <= 0) {
          document.getElementById("contador").textContent = "ğŸš« Prueba finalizada";
          return;
        }

        const dias = Math.floor(tiempoRestante / (1000 * 60 * 60 * 24));
        const horas = Math.floor((tiempoRestante / (1000 * 60 * 60)) % 24);
        const minutos = Math.floor((tiempoRestante / (1000 * 60)) % 60);
        const segundos = Math.floor((tiempoRestante / 1000) % 60);

        document.getElementById("contador").textContent =
          `${dias} dÃ­as, ${horas}h ${minutos}m ${segundos}s`;
      }

      setInterval(actualizarContador, 1000);
      actualizarContador();
    </script>
  {% endif %}
{% endblock %}

