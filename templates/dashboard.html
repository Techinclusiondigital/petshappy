{% extends "base.html" %}
{% block title %}Panel de Control{% endblock %}

{% block content %}
{% set usuario_real = current_user.usuario_principal or current_user %}

{% if current_user.usuario_principal_id is none and not usuario_real.subscripcion_id and not usuario_real.en_periodo_prueba() %}
  <div class="alert alert-danger text-center">
    <h2>üö´ Tu prueba gratuita ha caducado</h2>
    <p>Activa tu suscripci√≥n para seguir usando la aplicaci√≥n</p>  
    <div style="display: flex; justify-content: center;">
      <div id="paypal-button-container" style="max-width: 400px; width: 100%;"></div>
    </div>
  </div>
{% elif usuario_real.en_periodo_prueba() and not usuario_real.subscripcion_id %}
  <div class="alert alert-info text-center">
    <h4>‚è≥ Tu prueba gratuita finaliza en:</h4>
    <div id="contador" style="font-size: 16px; font-weight: bold;"></div>
  </div>
{% endif %}



{% if usuario_real.plan and (usuario_real.plan.max_usuarios is none or usuario_real.plan.max_usuarios > 1) %}
<!-- Bot√≥n de despliegue de usuarios asociados -->
<div onclick="toggleUsuarios()" style="cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
  <h5 style="margin: 0;"> Usuarios asociados</h5>
  <span id="flecha-gris" style="font-size: 1.0rem; color: gray;">‚¨áÔ∏è</span>
</div>

<div id="bloque-usuarios" style="display: none;">
  <p>Usuarios en tu plan: {{ usuario_real.usuarios_secundarios|length + 1 }} / {{ usuario_real.plan.max_usuarios or "‚àû" }}</p>

  

{% if current_user.usuario_principal_id is none and (usuario_real.plan.max_usuarios is none or usuario_real.usuarios_secundarios|length < usuario_real.plan.max_usuarios - 1) %}
<form method="POST" action="/dashboard/agregar_usuario" class="d-flex gap-2 align-items-center">
  <input type="text" name="nombre_usuario" placeholder="Nuevo usuario" required class="form-control">
  <input type="email" name="email" placeholder="Email" required class="form-control">
  <input type="password" name="password" placeholder="Contrase√±a" required class="form-control">

  <button type="submit" class="btn-igual">‚ûï A√±adir usuario</button>
  <a href="{{ url_for('ver_usuarios') }}" class="btn-igual">Ver usuarios</a>
</form>

  {% for u in usuarios %}
  <li>
    {{ u.nombre_usuario }} - {{ u.email }}
    </li>
{% endfor %}

{% elif current_user.usuario_principal_id is none %}
  <p style="color: red;">Has alcanzado el l√≠mite de usuarios de tu plan.</p>
{% endif %}
{% endif %}
  </div>
<br><br>
<div class="agenda-container">
<h2 class="text-center">üìÖ Agenda de Citas</h2>
<form method="GET" action="{{ url_for('dashboard') }}" class="fecha-form">
  <label for="fecha">üìÖ Selecciona una fecha:</label>
  <input type="date" id="fecha" name="fecha" required>
  
  <button class="btn-agenda">Ver agenda</button>
</form>


<div class="fecha-actual text-center my-3">
  <h3><strong>{{ agenda[0][1]|capitalize }} {{ agenda[0][0].strftime('%d/%m/%Y') }}</strong></h3>
</div>

<div class="navegacion-agenda-responsive">
  <a href="{{ url_for('dashboard', fecha=fecha_anterior) }}" class="btn btn-outline-primary">‚¨ÖÔ∏è D√≠a anterior</a>
  <a href="{{ url_for('dashboard', fecha=fecha_siguiente) }}" class="btn btn-outline-primary">D√≠a siguiente ‚û°Ô∏è</a>
</div>

<style>
  .navegacion-agenda-responsive {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 1rem;
    margin: 1rem 0;
  }

  @media (max-width: 576px) {
    .navegacion-agenda-responsive {
      padding: 0 0.5rem;
    }
  }
</style>
{# ===== AGENDA ===== #}
{% for fecha, nombre_dia, bloques in agenda %}
  <ul class="list-group mb-3">
    {% for bloque in bloques %}
      <li class="bloque-horario {% if not bloque.mascota %}libre{% else %}ocupado{% endif %}">
        {% if not bloque.mascota %}
          <a href="/cita?fecha={{ fecha }}&hora={{ bloque.hora }}" class="bloque-libre">{{ bloque.texto }}</a>
        {% else %}
          <div class="cita-card">
          <div class="cita-row cita-head">
  <div class="cita-hora">{{ bloque.hora }}</div>
  <a href="/mascota/{{ bloque.mascota.id }}" class="cita-nombre">
    {{ bloque.mascota.nombre }}
  </a>
</div>

            <div class="cita-row cita-meta">
              <span class="cita-servicio">{{ bloque.tipo_servicio or "Sin servicio" }}</span>
              <span class="cita-raza">({{ bloque.mascota.raza }} - {{ bloque.tamano }})</span>
              {% if bloque.tipo_corte is defined and bloque.tipo_corte %}
                <span class="cita-corte">‚Ä¢ Corte: {{ bloque.tipo_corte }}</span>
              {% endif %}
            </div>

            {% if bloque.cita_id %}
              <div class="cita-row cita-acciones">
                <form action="/actualizar_pago/{{ bloque.cita_id }}" method="POST" class="cita-pago-form">
                  <select name="metodo_pago" class="form-select form-select-sm">
                    <option value="">M√©todo</option>
                    <option value="efectivo" {% if bloque.metodo_pago == 'efectivo' %}selected{% endif %}>üíµ Efectivo</option>
                    <option value="tarjeta" {% if bloque.metodo_pago == 'tarjeta' %}selected{% endif %}>üí≥ Tarjeta</option>
                  </select>
                  <input type="number" step="0.01" name="precio" placeholder="‚Ç¨" value="{{ bloque.precio or '' }}" class="form-control form-control-sm">
                  <button type="submit" class="btn btn-sm btn-success">üíæ</button>
                </form>

                <form method="POST" action="/anular_cita/{{ bloque.cita_id }}" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-danger">‚ùå Anular</button>
                </form>

                {% if bloque.mascota.telefono %}
                  {% set telefono = bloque.mascota.telefono.replace(" ", "").replace("-", "") %}
                  {% set mensaje = "Hola! Te recordamos que tienes una cita ma√±ana con tu mascota " ~ bloque.mascota.nombre ~ " a las " ~ bloque.hora %}
                  <a class="btn btn-success btn-sm" target="_blank"
                     href="https://wa.me/34{{ telefono }}?text={{ mensaje | urlencode }}">
                    üì≤ Enviar recordatorio
                  </a>
                {% endif %}
                 </div>
              <div class="cita-row cita-extra">
  <a href="/cita?fecha={{ fecha }}&hora={{ bloque.hora }}" class="btn btn-sm btn-primary">
    ‚ûï Agendar otra cita a esta hora
  </a>
</div>
 
            {% endif %}
          </div>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% endfor %}

<button onclick="mostrarContacto()" class="btn-consultas">Consultas e Incidencias</button>

{# >>> CIERRE DEL BLOQUE CONTENT <<< #}
{% endblock %}


{% block scripts %}
{% if current_user.usuario_principal_id is none and not usuario_real.subscripcion_id and not usuario_real.en_periodo_prueba() %}
  <script src="https://www.paypal.com/sdk/js?client-id=AdKDB9XxfhHs8k-nO1sNPQVn2S2-kEih3HgO9Byj147xHOB4FLaIUVc0EGId3a6oECFgrdGP54KsQAUK&vault=true&intent=subscription"></script>
  <script>
    paypal.Buttons({
      style: {
        shape: 'rect',
        color: 'gold',
        layout: 'vertical',
        label: 'subscribe'
      },
      createSubscription: function(data, actions) {
        return actions.subscription.create({
          plan_id: 'P-0YP52904YG949224RNAY3BJY'
        });
      },
      onApprove: function(data, actions) {
        alert("‚úÖ Suscripci√≥n realizada. ID: " + data.subscriptionID);
        window.location.href = "/suscripcion_exitosa?sub_id=" + data.subscriptionID;
      }
    }).render('#paypal-button-container');
  </script>
{% elif usuario_real.en_periodo_prueba() and not usuario_real.subscripcion_id %}
  <script>
    const finPrueba = new Date("{{ fecha_fin_prueba.isoformat() }}");

    function actualizarContador() {
      const ahora = new Date();
      const tiempoRestante = finPrueba - ahora;

      if (tiempoRestante <= 0) {
        document.getElementById("contador").textContent = "üö´ Prueba finalizada";
        return;
      }

      const dias = Math.floor(tiempoRestante / (1000 * 60 * 60 * 24));
      const horas = Math.floor((tiempoRestante / (1000 * 60 * 60)) % 24);
      const minutos = Math.floor((tiempoRestante / (1000 * 60)) % 60);
      const segundos = Math.floor((tiempoRestante / 1000) % 60);

      document.getElementById("contador").textContent =
        `${dias} d√≠as, ${horas}h ${minutos}m ${segundos}s`;
    }

    actualizarContador();
    setInterval(actualizarContador, 1000);
  </script>

{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.toggleUsuarios = function() {
      const bloque = document.getElementById('bloque-usuarios');
      const flecha = document.getElementById('flecha-gris');
      const visible = bloque.style.display === 'block';

      bloque.style.display = visible ? 'none' : 'block';
      flecha.textContent = visible ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è';
    };
  });
</script>
<script>
  function mostrarContacto() {
    alert("üìß Email: techinclusiondigital@gmail.com\nüìû Tel√©fono: +34 641 75 2417");
  }
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (window.innerWidth < 576) {
      document.querySelector('.btn-agenda')?.style.setProperty("margin-top", "1rem");
    }
  });
</script>

{% endblock %}

